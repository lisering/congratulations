{% extends "layout.html" %}
{% block title %} 阳光15周年庆 {% endblock %}
{% block content %}

<body class="body">
    <script>
        function isWeiXin() {
            var ua = window.navigator.userAgent.toLowerCase();
            console.log(ua);//mozilla/5.0 (iphone; cpu iphone os 9_1 like mac os x) applewebkit/601.1.46 (khtml, like gecko)version/9.0 mobile/13b143 safari/601.1
            if (ua.match(/MicroMessenger/i) == 'micromessenger') {
                return true;
            } else {
                return false;
            }
        }
        if (!isWeiXin()) {
            location.href = '/wx';
        }
    </script>
    <div class="modals text-center hide" id="modal1">
        <img src="../images/arrow.png" class="img-responsive">
        <div class="li text-center tt">
            <span id="imgmodal"></span>
        </div>
        <img src="../images/stext.png" class="img-responsive">
    </div>
    <img src="../images/cb.jpg" class="img-responsive">
    <div class="container gradient">
        <form id="search">
            <div class="row">
                <div class="col-xs-4" style="padding-right:0;">
                    <div class="form-group">
                        <select name="area" id="area" class="form-control">
                            <option value="">所有大区</option>
                            {% for area in areas %}
                            <option value="{{area}}">{{area}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-xs-4" style="padding-right:0;">
                    <div class="form-group">
                        <select name="province" id="province" class="form-control">
                            <option value="">省份</option>
                            {% for province in provinces %}
                            <option value="{{province}}">{{province}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="form-group">
                        <select name="city" id="city" class="form-control">
                            <option value="">城市</option>
                            {% for city in cities %}
                            <option value="{{city}}">{{city}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- <div class="col-xs-4" style="padding-right:0;">
                    <div class="form-group">
                        <select name="country" id="country" class="form-control">
                            <option value="">县区</option>
                            {% for country in countries %}
                            <option value="{{country}}">{{country}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div> -->
                <div class="col-xs-12">
                    <div class="form-group">
                        <input type="text" class="form-control" name="state" id="state" placeholder="输入网点">
                    </div>
                </div>
            </div>
        </form>
        <ul class="list-unstyled statelist" id="statelist">
            {% for state in states %}
            <li class="li">
                <div class="title text-center">
                    {{state.areaName}} - {{state.city}} - {{state.stateName}}
                </div>
                <div class="img">
                    <img src="{{state.stateImg}}" class="stateimg img-responsive">
                </div>
                <div class="votes clearfix">
                    <div class="pull-left">
                        <img class="heart" src="../images/heart.png">&nbsp;&nbsp;<span class="votequality"><span class="vote">{{state.stateVotes}}</span>&nbsp;票</span>
                    </div>
                    <div class="pull-right">
                        <a href="javascript:;" class="btn btn-default lp"><img class="btnicon" src="../images/lp.png" />&nbsp;拉票</a>&nbsp;&nbsp;
                        <button id="{{state.id}}" rel="{{state.stateName}}|||{{state.id}}" class="btn btn-default votebtn"><img class="btnicon" src="../images/vote.png" />&nbsp;投票</button>
                    </div>
                </div>
                <!-- <p class="text-muted">{{state.stateDescription}}</p> -->
            </li>
            {% endfor %}
        </ul>
    </div>
    <img src="../images/bt.jpg" class="img-responsive">
    <script>
        (function() {
            for (id in localStorage) {
                var $id = ($('#' + id));
                if ($id.size() === 1) {
                    $id.attr('disabled', 'disabled');
                }
            }
        })();
        function getQueryString(query) {
            var strObj = {};
            var strArr = location.search.slice(1).split('&');
            $.each(strArr, function (i, v) {
                arr = v.split('=');
                strObj[arr[0]] = arr[1];
            });
            if (strObj[query]) {
                return strObj[query];
            }
            return null;
        }
        // var openId = getQueryString('openid');
        function vote(e) {
            e.preventDefault();
            var $this = $(e.target);
            var rel = $this.attr('rel').split('|||');
            var stateName = rel[0];
            var id = rel[1];
            if (localStorage.getItem(id)) {
                return alert('您已经为“' + stateName + '”投过票了！');
            }
            if ($this.is(':disabled')) {
                return alert('您已经为“' + stateName + '”投过票了！');
            }
            $(e.target).attr('disabled', 'disabled');
            $.getJSON('/vote', {
                id: id
            }, function (data) {
                if (data.message === 'success') {
                    voteDom = $this.closest('li').find('.vote'),
                        vote = parseInt(voteDom.html(), 10) + 1;
                    $this.off('click', vote);
                    localStorage.setItem(id, stateName);
                    voteDom.html(vote);
                    alert('您为“' + stateName + '”投票成功！');
                }
            });
            // if (openId) {
            //     $.getJSON('/vote', {stateName: stateName, openId: openId}, function(data) {
            //         if (data.message === 'success') {
            //             voteDom = $this.closest('li').find('.vote'),
            //             vote = parseInt(voteDom.html(), 10) + 1;
            //             voteDom.html(vote);
            //             alert('您为“'+stateName+'”投票成功！');
            //         }
            //         if (data.message === 'failed'){
            //             return alert('您已经为“'+stateName+'”投过票了！');
            //         }
            //     });
            // } else {
            //     alert('非法用户！');
            // }
        }
        $('.votebtn').on('click', vote);

        //搜索
        function appendOption(targetEle, data, pele, dstr) {
            $.each(data, function (i, v) {
                dstr += '<option value="' + v + '">' + v + '</option>';
            });
            targetEle.html(dstr);
        }

        function search(stype, pele, dstr) {
            var stypeStr = stype ? '&stype=' + stype : '';
            $.ajax({
                type: 'get',
                url: '/search',
                data: $('#search').serialize() + stypeStr,
                success: function (data) {
                    if (!data.error) {
                        if (stype !== 'state' || stype !== null) {
                            appendOption($('#' + stype), data[stype], pele, dstr);
                        }
                        var str = '';
                        $.each(data.states, function (i, item) {
                            str += '<li class="li">'+
                                        '<div class="title text-center">'+
                                            item.areaName + ' - ' + item.city + ' - ' + item.stateName +
                                        '</div>'+
                                        '<div class="img">'+
                                            '<img src="' + item.stateImg + '" class="stateimg img-responsive">'+
                                        '</div>'+
                                        '<div class="votes clearfix">'+
                                            '<div class="pull-left">'+
                                                '<img class="heart" src="../images/heart.png">&nbsp;&nbsp;<span class="votequality"><span class="vote">' + item.stateVotes + '</span>&nbsp;票</span>'+
                                            '</div>'+
                                            '<div class="pull-right">'+
                                                '<a href="javascript:;" class="btn btn-default lp"><img class="btnicon" src="../images/lp.png">&nbsp;拉票</a>&nbsp;&nbsp;'+
                                                '<button rel="' + item.stateName + '|||' + item.id + '" class="btn btn-default votebtn"><img class="btnicon" src="../images/vote.png">&nbsp;投票</button>'+
                                            '</div>'+
                                        '</div>'+
                                        '<!-- <p class="text-muted">' + item.stateDescription + '</p> -->'+
                                    '</li>';
                        });
                        $('.votebtn').off('click', vote);
                        $('.lp').off('click', lp);
                        $('#statelist').html(str);
                        $('.votebtn').on('click', vote);
                        $('.lp').on('click', lp);
                    }
                }
            });
        }
        //搜索大区
        $('#area').on('change', function (e) {
            var dstr = '<option value="">省份</option>';
            $('#province').html(dstr);
            $('#city').html('<option value="">城市</option>');
            $('#country').html('<option value="">县区</option>');
            var stype = $(this).val() ? 'province' : null;
            search(stype, $(this), dstr);
        });
        //搜索省份
        $('#province').on('change', function (e) {
            var dstr = '<option value="">城市</option>';
            $('#city').html(dstr);
            $('#country').html('<option value="">县区</option>');
            var stype = $(this).val() ? 'city' : null;
            search(stype, $(this), dstr);
        });
        //搜索城市
        $('#city').on('change', function (e) {
            var dstr = '<option value="">县区</option>';
            $('#country').html(dstr);
            var stype = $(this).val() ? 'country' : null;
            search(stype, $(this), dstr);
        });
        //搜索县区
        // $('#country').on('change', function (e) {
        //     search('state', $(this), '');
        // });
        //在大区下搜索站点
        $('#state').on('input', function (e) {
            search('state');
        });

        //拉票
        $('.lp').on('click', lp);

        function lp(e) {
            e.preventDefault();
            var str = $(e.target).closest('li').find('.title').html();
            $('#imgmodal').html(str);
            $('#modal1').removeClass('hide');
        }
        $('#modal1').on('click', function (e) {
            $(this).addClass('hide');
        });
    </script>
    {% endblock %}
</body>